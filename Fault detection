import serial
import numpy as np
import joblib
import time
import matplotlib.pyplot as plt
import tkinter as tk
from tkinter import simpledialog

# 模型和预处理器路径
MODEL_PATH = "models/final_model.pkl"
SCALER_PATH = "models/scaler.pkl"

DATA_LENGTH = 480
SERIAL_PORT = 'COM15'
BAUD_RATE = 115200
TIMEOUT_SECONDS = 5

# 加载模型和预处理器
clf = joblib.load(MODEL_PATH)
scaler = joblib.load(SCALER_PATH)
print("模型加载成功。")

# 打开串口
ser = serial.Serial(SERIAL_PORT, BAUD_RATE, timeout=1)
time.sleep(2)
print("串口已打开，开始采集...")

# 采集数据
data = []
start_time = time.time()

while len(data) < DATA_LENGTH and (time.time() - start_time) < TIMEOUT_SECONDS:
    if ser.in_waiting:
        line = ser.readline().decode().strip()
        try:
            value = float(line)
            data.append(value)
        except:
            continue

ser.close()

if len(data) < DATA_LENGTH:
    print("数据采集超时，未达到目标采样点数。")
else:
    # 显示波形图
    plt.figure(figsize=(10, 4))
    plt.plot(data, label="Vibration Signal", color="blue")
    plt.title("采集到的振动波形")
    plt.xlabel("采样点")
    plt.ylabel("信号强度")
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()

    # 数据标准化并分类预测
    X = np.array(data).reshape(1, -1)
    X_scaled = scaler.transform(X)
    y_pred = clf.predict(X_scaled)
    print("预测类别为：", y_pred[0])

    # 弹出窗口显示结果
    root = tk.Tk()
    root.withdraw()  # 隐藏主窗口
    user_input = simpledialog.askstring(title="预测结果",
                                        prompt=f"预测类别为：{y_pred[0]}\n如需修改，请输入新类别：")
    if user_input:
        print("你修改后的类别是：", user_input)
    else:
        print("你接受了原始预测结果。")
